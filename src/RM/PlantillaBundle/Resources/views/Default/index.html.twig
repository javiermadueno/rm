{% extends 'RMComunicacionBundle:Edicion:baseEdicion.html.twig' %}

{% block title %}
    {{ parent() }} - {{ "plantilla" | trans|title }}
{% endblock %}


{% block tabcontent %}

	<div class="row-fluid">
		<div id="control_mensajes" class="span12">
            <script>
                jQuery(document).ready(function(){
                    {% for mensaje in app.session.flashBag.get('formulario') %}
                        jQuery.jGrowl('{{ mensaje|trans|capitalize }}', {
                            header: '{{ 'notificacion' |trans|title }}'
                        });
                    {% endfor %}
                });
            </script>
            {% for mensaje in app.session.flashBag.get('formulario') %}
                <div class="alert alert-success botonera_central">
                    <strong>{{ "Correcto" }}:</strong>{{ mensaje | trans }}
                </div>
            {% endfor %}
		</div>
	</div>

    <h4 class="widgettitle">{{ "cabecera.acciones.plantilla"|trans|title }}</h4>
    <div class="mediamgr_head">
        <table width="100%" style="margin-bottom: 30px;">
            <tbody>
            <tr>
                <td class="pull-right" width="100"><button class="btn btn-primary" onClick="importarPlantilla();">{{ "boton.importar" | trans }}</button></td>
                <td class="pull-right" width="100"><button class="btn btn-primary" onClick="exportarPlantilla();">{{ "boton.exportar" | trans }}</button></td>
                <td  class="pull-left"width="100"><button class="btn btn-primary" onClick="location.href='{{ path('direct_manager_edit_plantillas_descargar', {'id_comunicacion': id_comunicacion}) }}'; return false;">{{ "boton.descargar" | trans }}</button></td>
                <td class="pull-left" width="200"><button class="btn btn-primary" onClick="previsualizarPlantilla()">{{ "boton.previsualizar.plantilla" | trans }}</button></td>
            </tr>
            </tbody>
        </table>
        <form name="form1" id="form1" action="{{ path('direct_manager_edit_plantillas_upload', {'id_comunicacion': id_comunicacion}) }}" method="post" enctype="multipart/form-data">
            <label for="fichero">
                {{ "subir.plantilla.maquetada" | trans|title }}
            </label>
            <input id="fichero" name="fichero" type="file">
            <button class="btn btn-primary" type="submit" onClick="return subirPlantilla();">{{ "boton.subir" | trans }}</button>
        </form>
    </div>

	<form name="form2" id="form2" method="get" action="{{ path('direct_manager_crear_grupo_slots', {'id_comunicacion':id_comunicacion, 'id_plantilla':id_plantilla}) }}">
	
		<input type="hidden" id="contGrupoSlots" name="contGrupoSlots" value="0">
		<input type="hidden" id="listaGSAEliminar" name="listaGSAEliminar" value="">
		<input type="hidden" id="accionEjecutar" name="accionEjecutar" value="">
		<input type="hidden" id="id_comunicacion" name="id_comunicacion" value={{ id_comunicacion }}>
		<input type="hidden" id="id_plantilla" name="id_plantilla" value={{ id_plantilla }}>	

        <h4 class="widgettitle">{{ "grupo.slots"|trans|title }}</h4>
        <table class="table table-bordered responsive">
            <colgroup>
                <col class="con0" style="align: center;">
                <col class="con1">
                <col class="con0">
                <col class="con1">
                <col class="con0">
                <col class="con1">
            </colgroup>
            <thead>
            <tr>
                <th width="1%"><input type="checkbox" id="checkTodos" /></th>
                <th>{{ "Nombre" | trans }}</th>
                <th>{{ "Tipo" | trans }}</th>
                <th>{{ "numero.slots" | trans }}</th>
            </tr>
            </thead>
            <tbody id="capaContenidoGruposSlots">
            {% if selectGrupos == null %}
                <tr id=mensajeSinResultados name="mensajeSinResultados">
                    <td colspan="4">
                        <div class="alert alert-danger botonera_central">
                            <strong>
                                {{ "mensaje.error.no.gruposlots" | trans }}
                            </strong>
                        </div>

                    </td>
                </tr>
            {% else %}
                {% for objGrupo in selectGrupos %}
                    <tr>
                        <td>
                            <input class="elimGS" type="checkbox" name="eliminarGS{{objGrupo.idGrupo}}" value="{{objGrupo.idGrupo}}"/>
                        </td>
                        <td>
                            <a href="{{ path('direct_manager_editar_grupo_slots', {'id_plantilla': id_plantilla, 'id_grupo': objGrupo.idGrupo, 'id_comunicacion': id_comunicacion }) }}">{{ objGrupo.nombre }}</a>
                        </td>
                        <td>
                            {% if objGrupo.tipo ==1  %}
                                {{ "promocion" | trans }}
                            {% elseif objGrupo.tipo == 2 %}
                                {{ "creatividad" | trans }}
                            {% endif %}
                        </td>
                        <td>
                            {{ objGrupo.numSlots }}
                        </td>
                    </tr>
                {% endfor %}
            {% endif %}
            </tbody>
        </table>
		<table cellspacing="0" cellpadding="0" border="0">
            <tbody>
            <tr>
                <td width="100">
                    <button type="submit" class="btn btn-success" id="btonNuevoGrupoSlots">{{ "boton.nuevo" | trans }}</button>
                </td>
                <td width="100">
                    <button class="btn btn-danger" id="botonEliminar">{{ "boton.eliminar" | trans }}</button>
                </td>
            </tr>
            </tbody>
		</table>
	</form>


{% endblock %}

{% block javascripts %}
	{{ parent() }}
	
	<script type="text/javascript">

// 		$('#btonNuevoGrupoSlots').click(function(event){
// 			event.preventDefault(); //cancela el comportamiento por defecto
// 			//$('#mensajeSinResultados').hide();
// 			var cont = Number($('#contGrupoSlots').val()) + 1;
// 			$('#contGrupoSlots').val(cont);
			{% set crearUrl = url('direct_config_plantillas_listaGrupoSlots')%}
			var myUrl = '{{crearUrl}}';
// 			myUrl = myUrl.replace('-1', cont);
// 			var msg = "idNuevoGrupoSlots=" + cont;	
// 			$.ajax({  
// 			  type: "POST",  
// 			  url: myUrl,
// 			  data: msg,  
// 			  complete: function(objeto, exito){
// 				if(exito=="success"){
// 					$('#capaContenidoGruposSlots').append(objeto.responseText);
// 					habilitarSoloNumerosConDecimales();	               
// 	            }
// 	          },
// 			  error: function(objeto, quepaso, otroobj){		            
// 	          }
// 			}); 
// 		});
		
		$('#botonEliminar').click(function(event){
			event.preventDefault(); //cancela el comportamiento por defecto
			var existe = 0;
			$(".elimGS:checked").each(function() {
				existe = 1;
				var cur_val = $('#listaGSAEliminar').val();
				if(cur_val)
				  $('#listaGSAEliminar').val(cur_val + "," + this.value);
				else
				  $('#listaGSAEliminar').val(this.value);
		});

			if(existe == 0){
				alert("Debe de elegir al menos un registro");
			}
			else{
				if(confirm("¿Desea eliminar los Grupos de slots seleccionados?")){

					$('#accionEjecutar').val("eliminar");
                    $('#form2')[0].setAttribute('action', '{{ path('direct_manager_eliminar_grupo_slots') }}');
                    $('#form2')[0].setAttribute('method', 'POST');
					$('#form2')[0].submit();
				}
				else{
					 $('#listaGSAEliminar').val("");
				}
			}
		});
	
		$('#checkTodos').click(function(){
				if ($("#checkTodos").is(':checked')) {
					$('.elimGS').prop("checked", true);

		        } else {
		        	$('.elimGS').prop("checked", false);
		        }
		});

		
		function importarPlantilla(){
			var largo = 550;
			var altura = 450;
			var top = (screen.height-altura)/2;
			var izquierda = (screen.width-largo)/2;
			{% set nombreVentana = "Importar Plantilla" %}
			{% set crearUrl = url('direct_manager_edit_plantillas_importar', {'id_canal': objComunicacion.getIdCanal().getIdCanal(), 'id_comunicacion': id_comunicacion}) %}
			var myUrl = '{{crearUrl}}';
			var nomVentana = '{{ nombreVentana }}';
			window.open(myUrl, nomVentana, "width=" + largo + ",height=" + altura + ",top=" + top + ",left=" + izquierda);
		}

		function exportarPlantilla(){
			var largo = 550;
			var altura = 450;
			var top = (screen.height-altura)/2;
			var izquierda = (screen.width-largo)/2;
			{% set nombreVentana = "Exportar Plantilla" %}
			{% set crearUrl = url('direct_manager_edit_plantillas_exportar', {'id_canal': objComunicacion.getIdCanal().getIdCanal(), 'id_comunicacion': id_comunicacion}) %}
			var myUrl = '{{crearUrl}}';
			var nomVentana = '{{ nombreVentana }}';
			window.open(myUrl, nomVentana, "width=" + largo + ",height=" + altura + ",top=" + top + ",left=" + izquierda);
		}

		function previsualizarPlantilla(){

			var largo = 550;
			var altura = 450;
			var top = (screen.height-altura)/2;
			var izquierda = (screen.width-largo)/2;
            {# {% set nombreVentana = "Previsualizar Plantilla" %}
			{% set crearUrl = url('direct_manager_previsualizar_plantilla', {'id_comunicacion': id_comunicacion}) %}

            var myUrl = '{{crearUrl}}';
			var nomVentana = '{{ nombreVentana }}';
			window.open(myUrl, nomVentana, "width=" + largo + ",height=" + altura + ",top=" + top + ",left=" + izquierda); #}


            window.open('http://www.meydisvalencia.es/perfumeria/', 'Plantilla',"width=" + largo + ",height=" + altura + ",top=" + top + ",left=" + izquierda);
		}
		

		function subirPlantilla(){
			file = $('#fichero').val();
			extArray = new Array(".html");
			allowSubmit = false; 
			
			if (!file){
				alert("No ha seleccionado ningun fichero");
				return false;
			};
			while (file.indexOf("\\") != -1) file = file.slice(file.indexOf("\\") + 1);
			ext = file.slice(file.indexOf(".")).toLowerCase(); 
			for (var i = 0; i < extArray.length; i++) { 
				if (extArray[i] == ext) { 
					allowSubmit = true; 
					break; 
				} 
			} 
			if (allowSubmit) { 
				//Se comprueba el tama�a del fichero subido, una vez comprobado que es de extensi�n html
				//1048576 = 1M	
				var tamMega = 1048576;
				var tamFile = tamMega * 5; //5 Megas
				var fic = document.getElementById('fichero');
				if(fic.files != undefined){
					if(fic.files[0].size > tamFile){
						alert("El tama�o del fichero es demasiado grande.");
				        return false;
					}
				}				
				else {
					$('#form1').submit();
				}
			} 
			else { 
				alert("Usted sólo puede subir archivos con extensiones " + (extArray.join(" ")) + "\nPor favor seleccione un nuevo archivo");
				return false;
			}
		}
		
	</script>
{% endblock %}