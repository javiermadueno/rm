{% extends '@RMProducto/Promocion/base_promocion.html.twig' %}

{% set objInstancia = promocion.numPromocion.idInstancia %}

{% block widgettitle %}
    {{ "segmentadas" |trans|title }}
{% endblock widgettitle %}

{% block content %}
    {{ form_start(form, {'attr': {'class': 'form-horizontal', 'id': form.vars.id }}) }}
    <div id="content">
        <div class="row-fluid">
            <div class="span6">
                <fieldset>
                    <legend>{{ "creatividad" |trans|title }}</legend>

                    <div class="control-group {% if not form.descripcion.vars.valid %}error{% endif %}">
                        {{ form_label(form.descripcion, null, {'label_attr': {'class': 'control-label'} }) }}
                        <div class="controls">
                            {{ form_widget(form.descripcion, {'attr': {'class' : 'change span8' }}) }}
                            <span class="help-inline">
                                {% for error in form.descripcion.vars.errors %}
                                    {{ error.message }} <br/>
                                {% endfor %}
                            </span>
                        </div>
                    </div>

                    {% if form.nombreFiltro is defined %}
                        <div class="control-group">
                            {{ form_label(form.nombreFiltro, null,  {'label_attr': {'class': 'control-label'} }) }}
                            <div class="controls">
                                <div class="input-append span8">
                                    {{ form_widget(form.nombreFiltro, {'attr': {'style' : 'width: 95% !important' }}) }}
                                    <button class="btn segmentador" type="button"
                                            data-nombrefiltro="{{ form.nombreFiltro.vars.id }}"
                                            data-filtro="{{ form.filtro.vars.id }}">
                                        <i class="iconfa iconfa-filter"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {{ form_widget(form.filtro, {
                    'attr': {
                    'class': 'filtro',
                    'data-nombrefiltro': form.nombreFiltro.vars.id|default(''),
                    'data-promocion': promocion.idPromocion is not null ? promocion.idPromocion : -1
                    }
                    }) }}

                </fieldset>
            </div>
            <div class="span6">
                <fieldset>
                    <legend>{{ "select.seleccione.imagen" |trans|title}}</legend>
                    <div class="control-group {% if not form.creatividad.vars.valid %}error{% endif %}">
                        {{ form_label(form.creatividad, null,  {'label_attr': {'class': 'control-label'} }) }}
                        <div class="controls">
                            <select name="{{ form.creatividad.vars.full_name }}"
                                    {% if form.creatividad.vars.required %}required="required"{% endif %}
                                    id="{{ form.creatividad.vars.id }}"
                                    class="span12">
                                {% for choice in form.creatividad.vars.choices %}
                                    {% set creatividad = choice.data %}
                                    <option value="{{ choice.value }}"
                                            {% if form.creatividad.vars.value == choice.value %} selected {% endif %}
                                            data-imagesrc="{{ asset(app.user.cliente ~ '/' ~ imagenes_creatividad ~ creatividad.imagen, null, true) }}"
                                            data-description="{{ creatividad.descripcion }}"
                                            >
                                        {{ choice.label }}
                                    </option>
                                {% endfor %}
                            </select>
                            {%  do form.creatividad.setRendered  %}
                            <span class="help-inline">
                                {% for error in form.creatividad.vars.errors %}
                                    {{ error.message }} <br/>
                                {% endfor %}
                            </span>
                        </div>
                    </div>
                </fieldset>


            </div>
        </div>
    </div>
    <div class="row-fluid">
        <div class="form-actions">
            {{ form_widget(form.submit, {'attr': {'class': 'btn btn-primary' }}) }}
        </div>
    </div>
    {{ form_end(form) }}


    {% if promocion.tipo == constant('TIPO_SEGMENTADA', promocion) %}

        {% include 'RMSegmentoBundle:Default/Buscador:formPopUpBuscadorSegmentos.html.twig' %}

        <script type="text/javascript">
            $(document).on('ready', function () {

                function addCondicionSegmentoPadre(elem) {
                    if (typeof elem === 'undefined') {
                        return false;
                    }

                    var filtro = JSON.parse(elem.value);
                    var filtroCompleto = '{"$and": [__CONDICION__,{"ls": {"$in":[{{ objInstancia.idSegmentoComunicacion.idSegmento.idSegmento }}] } }]}';

                    filtroCompleto = filtroCompleto.replace('__CONDICION__', filtro.parse);
                    filtro.filtroCompleto = filtroCompleto;

                    elem.value = JSON.stringify(filtro);
                }



                $(document).on('click', '.segmentador', function (event) {
                    var e = event || window.event;
                    e.preventDefault();

                    $this = $(this);
                    buscarSegmentos($this.data('filtro'), $this.data('nombrefiltro'));
                });

                $(document).on('change', '.filtro', function () {
                    addCondicionSegmentoPadre(this);

                });


            });
        </script>
    {% else %}
        <script type="text/javascript">
            $(document).on('ready', function(){
                $('.filtro').each(function () {
                    addCondicionSegmentoPadreGenericas(this);
                });

                function addCondicionSegmentoPadreGenericas(elem) {
                    if (typeof elem === 'undefined') {
                        return false;
                    }

                    var filtro = '{"$and": [{"ls": {"$in": [{{ objInstancia.idSegmentoComunicacion.idSegmento.idSegmento }}] } } ] }';
                    var value = {
                        filtroCompleto: filtro
                    };

                    elem.value = JSON.stringify(value);
                }
            })
        </script>

{% endif %}

    <script src="{{ asset('js/jquery.ddslick.min.js') }}" type="text/javascript"></script>
    <script type="text/javascript">
        $(document).on('ready', function(){
            $('#{{ form.creatividad.vars.id }}').ddslick();
            $('#{{ form.vars.id  }}').on('submit', function(){
                $('#{{ form.creatividad.vars.id }}').ddslick('destroy');
                this.submit();
            });
        });
    </script>

{% endblock content %}
